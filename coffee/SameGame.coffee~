x_axis = 5
y_axis = 5
num = 4
first = new Array(y_axis)
delarray = new Array()

#数字の色付け
adcolor = ->
  # console.log $('#stage > button').html()
  for y in [0...y_axis]
    for x in [0...x_axis]
      # console.log $("##{y}_#{x}").html()
      switch $("##{y}_#{x}").html()
        # when '0' then $(@).css 'background-color':'#fff'
        when '0' then $("##{y}_#{x}").css 'background-color':'#000'
        when '1' then $("##{y}_#{x}").css 'background-color':'#0ff'
        when '2' then $("##{y}_#{x}").css 'background-color':'#ff0'
        when '3' then $("##{y}_#{x}").css 'background-color':'#f0f'
        # when '1' then $(@).css 'background-color':'#555'
        else $("##{y}_#{x}").css 'background-color':'#fff'



$ ->
  for y in [0...y_axis]
    first[y] = new Array(x_axis)
    for x in [0...x_axis]
      first[y][x] = _.random(1, num)
      $('#stage').append("""<button id="#{y}_#{x}" class="block" data-y="#{y}" data-x="#{x}">#{first[y][x]}</button>""")
      $('.block').css 'width':'50px', 'margin':'5px', 'float':'left'
    $('#stage').append("<br><br>")
    cparray = $.extend(true, [], first)
  adcolor()

  #ボタンが押されたら
  $('.block').bind 'click', ->
    delarray = new Array()
    x = parseInt($(@).attr 'data-x')
    y = parseInt($(@).attr 'data-y')
    # console.log $(@).text()
    # check = first[y][x]
    check = parseInt($(@).text())
#search
# 現在のデータが入った配列
# コピーする
# 消す候補を入れる配列 delarray -> 再帰
#
# コピーする
    search(y,x,check,cparray)
    del(delarray,cparray)
    adcolor()
    # console.log cparray

  #隣接する数字の探索
  search = (y,x,check,cparray) ->
    if y < 0 or y >= y_axis or x < 0 or x >= x_axis
      return
    if cparray[y][x] != check
      return
    if cparray[y][x] is 0
      return
    # if cparray[x+1][y] != check and cparray[x-1][y] != check and cparray[x][y+1] != check and cparray[x][y-1] != check
      return
    cparray[y][x] = 0
    $("##{y}_#{x}").text('0')
    # $("##{y}_#{x}").css 'background-color':'#248'
    delarray.push x: x, y: y
    search(y-1,x,check,cparray)
    search(y+1,x,check,cparray)
    search(y,x-1,check,cparray)
    search(y,x+1,check,cparray)
    return

  #削除メソッド
  del = (delarray,cparray) ->
    if delarray.length is 0
      return
    # for cell in delarray
      # console.log cell
      # console.log cell.y,cell.x
      # cparray[cell.y][cell.x] = 0
      # $("##{cell.y}_#{cell.x}").text('0')
      # $("##{cell.y}_#{cell.x}").css 'background-color':'#248'
      # console.log cparray
#縦に詰める
    for x in [0...x_axis]
      for y in [0...y_axis]
        # console.log cparray[y][x]
        if cparray[y][x] is 0
          # console.log "ok"
          # console.log "y=#{y}"
          # console.log "x=#{x}"
          # for prey in [y-1...]
          ypos = y - 1
          # console.log ypos
          while ypos >= 0
            # console.log "y=#{y},x=#{x}"
            # console.log "ypos=#{ypos},#{x}"
            # console.log "cparray[ypos][x]=#{cparray[ypos][x]}"
            # console.log cparray[ypos][x]
            if cparray[ypos][x] != 0
              cparray[ypos+1][x] = cparray[ypos][x]
              cparray[ypos][x] = 0
              # del
              # tsumeru()
              # console.log cparray[y][x]
              # console.log cparray[ypos][x]
              # cparray[y][x].y = 
            # console.log "cparray2 = #{cparray[ypos][x]}"
            ypos--
            console.log x
#横に詰める
    # fixy = y_axis-1
    # for x in [0...x_axis]
    #   if cparray[fixy][x] is 0
    #     xpos = x + 1
    #     while xpos < x_axis
    #       if cparray[fixy][xpos] != 0
    #         ypos = y_axis - 1
    #         while ypos >= 0
    #           cparray[ypos][x] = cparray[ypos][xpos]
    #           cparray[ypos][xpos] = 0
    #           ypos--
    #       xpos++

    fixy = y_axis-1
    for x in [0...x_axis-1]
      if cparray[fixy][x] is 0
        xpos = x + 1
        ypos = y_axis - 1
        while ypos >= 0
          cparray[ypos][x] = cparray[ypos][xpos]
          cparray[ypos][xpos] = 0
          ypos--

    # $('#stage > *').remove() if $('#stage').get(0)
    # console.log cparray
    for cpx,i  in cparray
        # console.log cpx
      for cpy,j in cpx
        # console.log i
        # console.log j
        # console.log
        $("##{i}_#{j}").text("#{cpy}")
        # console.log "cpy=#{cpy}"
return
